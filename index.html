<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Página de Producto</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f5f5f5;
        }
        .breadcrumb a:hover {
            color: #3483fa;
        }
        .thumbnail-selected {
            border: 2px solid #3483fa;
        }
        /* Estilos para la barra de reputación */
        .reputation-bar-segment {
            height: 8px;
            width: 20%; /* 100% / 5 segmentos */
            border-radius: 2px;
            margin-right: 2px; /* Pequeño espacio entre segmentos */
            /* Colores base muy claros para los segmentos no resaltados */
        }
        .reputation-bar-segment.reputation-level-1 { background-color: rgba(239, 68, 68, 0.2); /* red-500 con 20% opacidad */ }
        .reputation-bar-segment.reputation-level-2 { background-color: rgba(249, 115, 22, 0.2); /* orange-500 con 20% opacidad */ }
        .reputation-bar-segment.reputation-level-3 { background-color: rgba(245, 158, 11, 0.2); /* yellow-500 con 20% opacidad */ }
        .reputation-bar-segment.reputation-level-4 { background-color: rgba(132, 204, 22, 0.2); /* lime-500 con 20% opacidad */ }
        .reputation-bar-segment.reputation-level-5 { background-color: rgba(34, 197, 94, 0.2); /* green-500 con 20% opacidad */ }

        .reputation-bar-segment:last-child {
            margin-right: 0;
        }
        /* Colores para el segmento resaltado */
        .reputation-level-1.highlighted { background-color: #ef4444; /* red-500 */ }
        .reputation-level-2.highlighted { background-color: #f97316; /* orange-500 */ }
        .reputation-level-3.highlighted { background-color: #f59e0b; /* yellow-500 */ }
        .reputation-level-4.highlighted { background-color: #84cc16; /* lime-500 (light green) */ }
        .reputation-level-5.highlighted { background-color: #22c55e; /* green-500 */ }

        /* Colores para iconos de reputación */
        .icon-green { color: #22c55e; /* green-500 */ }
        .icon-red { color: #ef4444; /* red-500 */ }

        /* Estilos para la barra de tamaño de pantalla */
        .size-bar-segment {
            height: 8px;
            width: 20%;
            border-radius: 2px;
            margin-right: 2px;
            background-color: #e0e0e0; /* Gris para no resaltado */
        }
        .size-bar-segment:last-child {
            margin-right: 0;
        }
        .size-bar-segment.highlighted {
            background-color: #3483fa; /* Azul para resaltado */
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="container mx-auto p-4 max-w-7xl">
        <!-- Breadcrumbs -->
        <div class="text-sm text-gray-600 mb-4 breadcrumb">
            <a href="#" class="hover:text-blue-500">Volver al listado</a> |
            <a href="#" class="hover:text-blue-500">Celulares y Smartphones</a>
        </div>

        <div id="product-card" class="bg-white rounded-lg shadow-md p-6 hidden">
            <!-- Contenedor Principal del Producto (Grid) -->
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">

                <!-- Columna Izquierda Principal (Miniaturas, Imagen Grande, Título/Valoraciones, Productos Relacionados, Vendedor, Características, Descripción) -->
                <div class="lg:col-span-9 order-1">
                    <div class="grid grid-cols-1 lg:grid-cols-9 gap-8">
                        <!-- Columna 1: Miniaturas -->
                        <div class="lg:col-span-1 flex lg:flex-col items-start gap-2 order-2 lg:order-1">
                            <div id="thumbnails" class="flex lg:flex-col gap-2"></div>
                        </div>

                        <!-- Columna 2: Imagen Principal -->
                        <div class="lg:col-span-5 flex justify-center items-start order-1 lg:order-2">
                            <img id="main-image" src="" alt="Imagen principal del producto" class="max-w-full h-auto max-h-[450px] object-contain rounded-lg">
                        </div>

                        <!-- Columna 3: Título y Valoraciones (ahora incluye tienda oficial y precio) -->
                        <div class="lg:col-span-3 order-3">
                            <div id="official-store" class="hidden items-center gap-2 text-sm text-blue-500 font-semibold mb-2">
                                <i class="fas fa-store"></i> <span id="store-name"></span>
                            </div>
                            <p class="text-xs text-gray-500 mb-2">Nuevo | <span id="sales-info"></span></p>
                            <h1 id="product-title" class="text-2xl font-semibold text-gray-800 mb-4"></h1>
                            <div class="flex items-center gap-2 my-4">
                                <span id="product-rating" class="text-blue-500 font-semibold"></span>
                                <div id="rating-stars" class="flex text-blue-500"></div>
                                <span id="product-reviews" class="text-sm text-gray-500"></span>
                            </div>
                            <!-- Precio y descuento movidos aquí -->
                            <p class="text-gray-500 text-sm line-through" id="old-price"></p>
                            <div class="flex items-baseline gap-2">
                                <span id="product-price" class="text-3xl font-light text-gray-800"></span>
                                <span id="price-discount" class="text-green-600 font-semibold text-lg"></span>
                            </div>
                            <p class="text-sm text-gray-600 mb-4">en 12x <span id="installments"></span></p>

                            <!-- Nuevo: Color y imagen de muestra -->
                            <div class="mt-6">
                                <p class="font-semibold text-gray-800 mb-2">Color: Único</p>
                                <div class="flex items-center gap-2">
                                    <img id="color-sample-image" src="" alt="Muestra de color" class="w-12 h-12 rounded-md border border-blue-500 object-contain">
                                </div>
                            </div>

                            <!-- Nuevo: Lo que tienes que saber de este producto -->
                            <div class="mt-8 border-t pt-6">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4">Lo que tienes que saber de este producto</h3>
                                <ul id="main-features-list" class="list-disc list-inside space-y-2 text-gray-700">
                                    <!-- Las 3 características principales se insertarán aquí -->
                                </ul>
                                <a href="#product-features-full" id="view-all-features-link" class="text-blue-500 hover:text-blue-700 text-sm font-semibold mt-4 block">Ver características</a>
                            </div>
                        </div>
                    </div>

                    <!-- SECCIÓN DE PRODUCTOS RELACIONADOS -->
                    <div id="related-products-section" class="mt-12 hidden">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-6">Productos relacionados</h2>
                        <div id="related-products-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                        </div>
                    </div>

                    <!-- SECCIÓN DE PRODUCTOS DEL VENDEDOR -->
                    <div id="seller-products-section" class="mt-12 hidden">
                        <h2 id="seller-products-title" class="text-2xl font-semibold text-gray-800 mb-6"></h2>
                        <div id="seller-products-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                        </div>
                    </div>

                    <!-- Características del producto (movido aquí) -->
                    <div id="product-features-full" class="border-t mt-6 pt-6">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">Características del producto</h2>
                        <!-- Changed this div to a grid for two columns -->
                        <div id="product-features" class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4"></div>
                    </div>

                    <!-- Descripción (movido aquí) -->
                    <div class="mt-12 border-t pt-8">
                           <h2 class="text-2xl font-semibold text-gray-800 mt-10 mb-4">Descripción</h2>
                           <p id="product-description" class="text-gray-600 leading-relaxed whitespace-pre-line max-w-4xl"></p>
                    </div>
                </div>

                <!-- Columna Derecha Principal (Compra e Información, y Cuadro del Vendedor) -->
                <div class="lg:col-span-3 order-4">
                    <div class="border border-gray-200 rounded-lg p-6">
                        <!-- seller-info-section y price elements eliminados de aquí -->
                        <div class="flex items-center gap-2 text-green-600 font-semibold my-4">
                            <i class="fas fa-shipping-fast"></i> <span id="shipping-info"></span>
                        </div>

                        <div class="mb-4">
                            <p class="font-semibold text-sm">Stock disponible</p>
                            <p class="text-sm text-gray-500">Cantidad: <span id="stock-available"></span> disponibles</p>
                        </div>
                        <div class="flex flex-col gap-2">
                            <button class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 rounded-md transition-colors">Comprar ahora</button>
                            <button class="w-full bg-blue-100 hover:bg-blue-200 text-blue-500 font-semibold py-3 rounded-md transition-colors">Agregar al carrito</button>
                        </div>
                        <div class="mt-6 text-sm text-gray-600 space-y-3">
                            <div class="flex gap-3"><i class="fas fa-undo-alt mt-1 text-gray-400"></i><p><span class="text-blue-500">Devolución gratis.</span></p></div>
                            <div class="flex gap-3"><i class="fas fa-shield-alt mt-1 text-gray-400"></i><p><span class="text-blue-500">Compra Protegida.</span></p></div>
                        </div>
                    </div>

                    <!-- Nuevo cuadro de información del vendedor (fuera del cuadro de compra) -->
                    <div id="seller-details-box" class="mt-6 border border-gray-200 rounded-lg p-4">
                        <div id="seller-cover-image-container" class="w-full h-24 overflow-hidden rounded-md mb-3 hidden">
                            <img id="seller-cover-image" src="" alt="Imagen de portada del vendedor" class="w-full h-full object-cover">
                        </div>
                        <div class="relative -mt-8 ml-3 flex flex-col items-start"> <!-- Ajustado -mt-8 para w-16 h-16, y flex-col para el texto debajo -->
                            <img id="seller-details-image" src="" alt="Imagen de perfil del vendedor" class="w-16 h-16 rounded-md border-2 border-white object-contain shadow-md hidden">
                            <div class="mt-2"> <!-- Contenedor para nombre y productos, ahora debajo de la imagen -->
                                <p id="seller-details-name" class="font-semibold text-gray-800 text-lg"></p>
                                <p id="seller-details-products-count" class="text-sm text-gray-500"></p>
                            </div>
                        </div>
                        <div class="flex flex-col gap-2 mb-4">
                            <p class="text-sm text-gray-600">Reputación del vendedor:</p>
                            <div id="reputation-bar" class="flex w-full">
                                <!-- Los segmentos de la barra de reputación se renderizarán aquí -->
                            </div>
                        </div>
                        <div class="grid grid-cols-3 gap-4 text-center">
                            <div>
                                <p class="font-semibold text-gray-800 text-lg" id="seller-details-sales-count-bottom"></p>
                                <p class="text-sm text-gray-500" id="seller-sales-text"></p>
                            </div>
                            <div>
                                <i id="attention-icon" class="fas text-xl mb-1"></i>
                                <p class="text-sm text-gray-500" id="attention-level-text"></p>
                            </div>
                            <div>
                                <i id="delivery-icon" class="fas text-xl mb-1"></i>
                                <p class="text-sm text-gray-500" id="delivery-time-text"></p>
                            </div>
                        </div>
                        <button id="view-seller-products-btn" class="w-full bg-blue-100 hover:bg-blue-200 text-blue-500 font-semibold py-3 rounded-md transition-colors mt-4">Ver más productos del vendedor</button>
                    </div>
                    <!-- Fin del nuevo cuadro de información del vendedor -->

                    <!-- Nuevo: Otras opciones de compra -->
                    <div class="mt-6 border border-gray-200 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">Otras opciones de compra</h3>
                        <!-- Added id="other-options-link" to this anchor tag -->
                        <a href="#" id="other-options-link" class="text-blue-500 hover:text-blue-700 text-sm">Ver 3 opciones desde U$S 439</a>
                    </div>

                    <!-- Nuevo: Métodos de pago -->
                    <div class="mt-6 border border-gray-200 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Métodos de pago</h3>
                        <div class="bg-green-600 text-white p-3 rounded-md flex items-center gap-2 mb-4">
                            <i class="fas fa-credit-card text-xl"></i>
                            <span>¡Paga en hasta 12 cuotas sin interés!</span>
                        </div>
                        <div id="payment-methods-content">
                            <!-- Payment methods will be dynamically loaded here -->
                        </div>
                        <a href="#" class="text-blue-500 hover:text-blue-700 text-sm font-semibold mt-4 block">Conoce otros medios de pago</a>
                    </div>

                </div>
            </div>
        </div>

        <div id="loading-state" class="text-center py-10"><p class="text-lg text-gray-600">Cargando producto...</p></div>
        <div id="error-state" class="text-center py-10 hidden">
               <p class="text-lg text-red-600">Error al cargar el producto.</p>
               <p class="text-sm text-gray-500 mt-2">Asegúrate de que el servidor backend esté funcionando.</p>
        </div>
    </div>

    <script>

        // Function to simulate the `GET /producto/{id}` API call
        function fetchProductById(productId) {
            // Uncomment the line below and comment the Promise.resolve line to use a backend server
            return fetch(`http://localhost:8080/producto/${productId}`).then(res => res.json());
            // return Promise.resolve(productDatabase[productId]); // For local development
        }

        // Function to simulate the `GET /producto/listAll` API call
        function fetchAllProducts() {
            // Uncomment the line below and comment the Promise.resolve line to use a backend server
            return fetch('http://localhost:8080/producto/listAll').then(res => res.json());
            // return Promise.resolve(productDatabase); // For local development
        }

        // Function to simulate the `GET /vendedor/{id}` API call
        function fetchSellerById(sellerId) {
            // Uncomment the line below and comment the Promise.resolve line to use a backend server
            return fetch(`http://localhost:8080/vendedor/${sellerId}`).then(res => res.json());
            // return Promise.resolve(sellerDatabase[sellerId]); // For local development
        }

        // Function to simulate the `GET /vendedor/listAll` API call
        function fetchAllSellers() {
            // Uncomment the line below and comment the Promise.resolve line to use a backend server
            return fetch('http://localhost:8080/vendedor/listAll').then(res => res.json());
            // return Promise.resolve(sellerDatabase); // For local development
        }

        // Function to load product data based on URL parameter
        async function loadProductData() {
            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('id') || "a55-5g-256gb-azul"; // Default product ID

            const productCard = document.getElementById('product-card');
            const loadingState = document.getElementById('loading-state');
            const errorState = document.getElementById('error-state');

            loadingState.classList.remove('hidden'); // Show loading state
            productCard.classList.add('hidden'); // Hide product card
            errorState.classList.add('hidden'); // Hide error state

            try {
                const [product, allProducts, allSellers] = await Promise.all([
                    fetchProductById(productId),
                    fetchAllProducts(),
                    fetchAllSellers()
                ]);

                // Convert allProducts and allSellers from arrays (if API returns them as such) to objects for easier lookup
                const productsById = {};
                if (Array.isArray(allProducts)) {
                    allProducts.forEach(p => productsById[p.id] = p);
                } else {
                    Object.assign(productsById, allProducts); // If it's already an object
                }

                const sellersById = {};
                if (Array.isArray(allSellers)) {
                    allSellers.forEach(s => sellersById[s.id] = s);
                } else {
                    Object.assign(sellersById, allSellers); // If it's already an object
                }

                if (!product) {
                    throw new Error(`Producto no encontrado para ID: ${productId}`);
                }

                const seller = sellersById[product.vendedor_id];

                renderProduct(product, seller);
                renderRelatedProducts(productsById, productId); // Pass the object
                renderSellerProducts(productsById, productId, product.vendedor_id, seller ? seller.nombre : 'Vendedor'); // Pass the object

                loadingState.classList.add('hidden');
                productCard.classList.remove('hidden');

            } catch (error) {
                console.error("Error al cargar los datos:", error);
                loadingState.classList.add('hidden');
                errorState.classList.remove('hidden');
            }
        }

        document.addEventListener('DOMContentLoaded', loadProductData);
        // Listen for popstate event to handle browser back/forward buttons
        window.addEventListener('popstate', loadProductData);


        function renderProduct(product, seller) {
            // --- Fill product data ---
            document.title = product.titulo;
            document.getElementById('product-title').textContent = product.titulo;
            document.getElementById('product-description').textContent = product.descripcion;
            
            // Sales and seller information (top section)
            if (seller && seller.ventas_concretadas) {
                document.getElementById('sales-info').textContent = `${seller.ventas_concretadas} vendidos`;
            } else {
                document.getElementById('sales-info').textContent = ''; // Clear if no sales info
            }
            
            document.getElementById('product-rating').textContent = product.valoracion;
            document.getElementById('product-reviews').textContent = `(${product.total_reviews} opiniones)`;

            // Render stars based on rating
            const ratingStarsContainer = document.getElementById('rating-stars');
            ratingStarsContainer.innerHTML = '';
            const fullStars = Math.floor(product.valoracion);
            const hasHalfStar = product.valoracion % 1 !== 0;

            for (let i = 0; i < fullStars; i++) {
                const star = document.createElement('i');
                star.className = 'fas fa-star';
                ratingStarsContainer.appendChild(star);
            }
            if (hasHalfStar) {
                const halfStar = document.createElement('i');
                halfStar.className = 'fas fa-star-half-alt';
                ratingStarsContainer.appendChild(halfStar);
            }
            // Fill remaining stars with empty stars up to 5
            for (let i = ratingStarsContainer.children.length; i < 5; i++) {
                const emptyStar = document.createElement('i');
                emptyStar.className = 'far fa-star'; // far for empty star
                ratingStarsContainer.appendChild(emptyStar);
            }

            // Price and discount
            const price = new Intl.NumberFormat('es-UY').format(product.precio);
            document.getElementById('product-price').textContent = `${product.moneda} ${price}`;
            const oldPriceEl = document.getElementById('old-price');
            const discountEl = document.getElementById('price-discount');
            if (product.precio_anterior && product.precio_anterior > product.precio) {
                oldPriceEl.textContent = `${product.moneda} ${new Intl.NumberFormat('es-UY').format(product.precio_anterior)}`;
                const discount = Math.round(((product.precio_anterior - product.precio) / product.precio_anterior) * 100);
                discountEl.textContent = `${discount}% OFF`;
                [oldPriceEl, discountEl].forEach(el => el.classList.remove('hidden'));
            } else {
                [oldPriceEl, discountEl].forEach(el => el.classList.add('hidden'));
            }
            const installmentPrice = new Intl.NumberFormat('es-UY', { style: 'currency', currency: 'USD' }).format(product.precio / 12);
            document.getElementById('installments').textContent = `${installmentPrice.replace('USD', 'U$S')} sin interés`;

            // Shipping and stock info
            document.getElementById('shipping-info').textContent = product.envio_gratis ? "Envío gratis" : "Calcular costo";
            document.getElementById('stock-available').textContent = product.stock;

            // Seller information (top section) - This section is no longer needed in the buy box
            // Official store information is moved next to the product title.
            // Small seller image and sales counter are removed from here.
            const officialStoreEl = document.getElementById('official-store');
            if (seller && seller.tienda_oficial) {
                officialStoreEl.classList.remove('hidden');
                officialStoreEl.classList.add('flex');
                document.getElementById('store-name').textContent = `Tienda oficial de ${seller.nombre}`;
            } else {
                officialStoreEl.classList.add('hidden');
                officialStoreEl.classList.remove('flex');
            }
            // Remove logic for sellerImageEl, sellerNameDisplayEl, and sellerSalesCountEl from this section
            // as they are now managed in sellerDetailsBox or have been moved.


            // Detailed seller information (new box)
            const sellerDetailsBox = document.getElementById('seller-details-box');
            const sellerCoverImageContainer = document.getElementById('seller-cover-image-container');
            const sellerCoverImage = document.getElementById('seller-cover-image');
            const sellerDetailsImage = document.getElementById('seller-details-image'); // Large profile image
            const sellerDetailsName = document.getElementById('seller-details-name');
            const sellerDetailsProductsCount = document.getElementById('seller-details-products-count');
            const sellerDetailsSalesCountBottom = document.getElementById('seller-details-sales-count-bottom');
            const reputationBar = document.getElementById('reputation-bar');
            const attentionIcon = document.getElementById('attention-icon');
            const attentionLevelText = document.getElementById('attention-level-text');
            const deliveryIcon = document.getElementById('delivery-icon');
            const deliveryTimeText = document.getElementById('delivery-time-text');
            const viewSellerProductsBtn = document.getElementById('view-seller-products-btn');

            if (seller) {
                sellerDetailsBox.classList.remove('hidden');
                
                // Cover image
                if (seller.imagen_portada) {
                    sellerCoverImage.src = seller.imagen_portada;
                    sellerCoverImageContainer.classList.remove('hidden');
                } else {
                    sellerCoverImageContainer.classList.add('hidden');
                }

                // Profile image (square) and its text below
                const sellerProfileAndTextContainer = sellerDetailsImage.parentElement;
                sellerProfileAndTextContainer.classList.remove('flex', 'items-start', 'gap-3');
                sellerProfileAndTextContainer.classList.add('flex', 'flex-col', 'items-start'); // Align content to the left

                if (seller.imagen_perfil) {
                    sellerDetailsImage.src = seller.imagen_perfil;
                    // Changed object-cover to object-contain
                    sellerDetailsImage.classList.remove('hidden', 'object-cover');
                    sellerDetailsImage.classList.add('object-contain');
                } else {
                    sellerDetailsImage.classList.add('hidden');
                }
                sellerDetailsName.textContent = seller.nombre;
                document.getElementById('seller-sales-text').textContent = `${seller.ventas_concretadas} ventas concretadas`;
                sellerDetailsProductsCount.textContent = `+${seller.cantidad_productos} Productos`;
                sellerDetailsSalesCountBottom.textContent = `+${seller.ventas_concretadas}`;

                reputationBar.innerHTML = ''; // Clear the bar before rendering
                const reputationLevels = [
                    { level: 1, colorClass: 'reputation-level-1', attention: 'Brinda mala atención' },
                    { level: 2, colorClass: 'reputation-level-2', attention: 'Brinda mala atención' },
                    { level: 3, colorClass: 'reputation-level-3', attention: 'Brinda regular atención' },
                    { level: 4, colorClass: 'reputation-level-4', attention: 'Brinda buena atención' },
                    { level: 5, colorClass: 'reputation-level-5', attention: 'Brinda buena atención' }
                ];

                for (let i = 0; i < 5; i++) {
                    const segment = document.createElement('div');
                    segment.classList.add('reputation-bar-segment');
                    const levelData = reputationLevels[i];
                    
                    // Apply very faint base color to all segments
                    segment.classList.add(`reputation-level-${i + 1}`);

                    // Highlight only the segment corresponding to the reputation level
                    if (seller.reputacion && seller.reputacion.nivel === (i + 1)) {
                        segment.classList.add('highlighted');
                    }
                    reputationBar.appendChild(segment);
                }

                // Attention level
                if (seller.reputacion) {
                    const currentReputationLevel = reputationLevels[seller.reputacion.nivel - 1];
                    attentionLevelText.textContent = currentReputationLevel.attention;
                    if (seller.reputacion.nivel >= 3) { // Assuming 3, 4, 5 are "good attention"
                        attentionIcon.className = 'fas fa-comment-dots icon-green text-xl mb-1';
                    } else {
                        attentionIcon.className = 'fas fa-comment-dots icon-red text-xl mb-1';
                    }
                }

                // On-time delivery
                if (seller.reputacion && seller.reputacion.entrega_a_tiempo !== undefined) {
                    if (seller.reputacion.entrega_a_tiempo) {
                        deliveryTimeText.textContent = 'Entrega sus productos a tiempo';
                        deliveryIcon.className = 'fas fa-truck icon-green text-xl mb-1';
                    } else {
                        deliveryTimeText.textContent = 'No entrega sus productos a tiempo';
                        deliveryIcon.className = 'fas fa-truck icon-red text-xl mb-1';
                    }
                }

                // "View more seller products" button
                viewSellerProductsBtn.onclick = () => {
                    const sellerProductsSection = document.getElementById('seller-products-section');
                    if (sellerProductsSection) {
                        sellerProductsSection.scrollIntoView({ behavior: 'smooth' });
                    }
                };

            } else {
                sellerDetailsBox.classList.add('hidden');
            }

            // Image gallery
            const mainImage = document.getElementById('main-image');
            const thumbnailsContainer = document.getElementById('thumbnails');
            thumbnailsContainer.innerHTML = '';
            mainImage.src = product.imagenes[0];
            product.imagenes.forEach((imgUrl, index) => {
                const thumbContainer = document.createElement('div');
                thumbContainer.className = 'w-12 h-12 p-1 border border-gray-300 rounded-md cursor-pointer hover:border-blue-500 transition-all';
                if (index === 0) thumbContainer.classList.add('thumbnail-selected');
                thumbContainer.innerHTML = `<img src="${imgUrl}" alt="Miniatura ${index + 1}" class="w-full h-full object-contain">`;
                thumbContainer.addEventListener('click', () => {
                    mainImage.src = imgUrl;
                    document.querySelectorAll('#thumbnails > div').forEach(t => t.classList.remove('thumbnail-selected'));
                    thumbContainer.classList.add('thumbnail-selected');
                });
                thumbnailsContainer.appendChild(thumbContainer);
            });

            // Set the color sample image
            const colorSampleImage = document.getElementById('color-sample-image');
            if (product.imagenes && product.imagenes.length > 0) {
                colorSampleImage.src = product.imagenes[0]; // Use the first image as the color sample
            } else {
                colorSampleImage.src = "https://placehold.co/48x48/cccccc/ffffff?text=N/A"; // Placeholder if no images
            }


            // Features (full list)
            const featuresContainer = document.getElementById('product-features');
            featuresContainer.innerHTML = '';
            const featureKeys = Object.keys(product.caracteristicas);

            for (const key of featureKeys) {
                const value = product.caracteristicas[key];
                let featureHtml = '';
                let iconClass = '';
                let formattedValue = value === true ? 'Sí' : value === false ? 'No' : value;

                if (key === 'pantalla') {
                    iconClass = 'fas fa-mobile-alt';
                    const screenSizeStr = String(value).split(' ')[0];
                    const screenSize = parseFloat(screenSizeStr);

                    let highlightedSegment = 0;
                    if (screenSize <= 4.5) {
                        highlightedSegment = 1;
                    } else if (screenSize < 5) {
                        highlightedSegment = 2;
                    } else if (screenSize < 6) {
                        highlightedSegment = 3;
                    } else if (screenSize < 7) {
                        highlightedSegment = 4;
                    } else { // >= 7
                        highlightedSegment = 5;
                    }

                    featureHtml = `
                        <div class="flex items-center gap-3">
                            <i class="${iconClass} text-gray-500 text-xl"></i>
                            <div class="flex-grow">
                                <strong class="text-gray-600">Tamaño de la pantalla:</strong>
                                <span class="text-gray-500">${formattedValue}</span>
                                <div class="flex items-center mt-2">
                                    <span class="text-xs text-gray-500 mr-2">PEQUEÑO</span>
                                    <div class="flex flex-grow">
                    `;
                    for (let j = 1; j <= 5; j++) {
                        featureHtml += `<div class="size-bar-segment ${j === highlightedSegment ? 'highlighted' : ''}"></div>`;
                    }
                    featureHtml += `
                                    </div>
                                    <span class="text-xs text-gray-500 ml-2">GRANDE</span>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    switch (key) {
                        case 'memoria_ram':
                            iconClass = 'fas fa-memory';
                            break;
                        case 'almacenamiento':
                            iconClass = 'fas fa-hdd';
                            break;
                        case 'camara_frontal':
                            iconClass = 'fas fa-camera-retro';
                            break;
                        case 'camara_trasera':
                            iconClass = 'fas fa-camera';
                            break;
                        case 'nfc':
                            iconClass = 'fas fa-wifi';
                            break;
                        case 'lector_huellas':
                            iconClass = 'fas fa-fingerprint';
                            break;
                        default:
                            iconClass = 'fas fa-info-circle'; // Default icon
                    }
                    const formattedKey = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    featureHtml = `
                        <div class="flex items-center gap-3">
                            <i class="${iconClass} text-gray-500 text-xl"></i>
                            <div>
                                <strong class="text-gray-600">${formattedKey}:</strong>
                                <span class="text-gray-500"> ${formattedValue}</span>
                            </div>
                        </div>
                    `;
                }
                featuresContainer.innerHTML += featureHtml;
            }

            // Main features list (limited to 3)
            const mainFeaturesList = document.getElementById('main-features-list');
            mainFeaturesList.innerHTML = ''; // Clear previous features
            const mainFeatureKeys = Object.keys(product.caracteristicas).slice(0, 3); // Get first 3 keys

            mainFeatureKeys.forEach(key => {
                const value = product.caracteristicas[key];
                const formattedKey = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                const formattedValue = value === true ? 'Sí' : value === false ? 'No' : value;
                const listItem = document.createElement('li');
                listItem.textContent = `${formattedKey}: ${formattedValue}`;
                mainFeaturesList.appendChild(listItem);
            });

            // Scroll to full features when "Ver características" is clicked
            document.getElementById('view-all-features-link').addEventListener('click', (event) => {
                event.preventDefault();
                document.getElementById('product-features-full').scrollIntoView({ behavior: 'smooth' });
            });

            // Update "Otras opciones de compra" link with dynamic price
            const otherOptionsLink = document.getElementById('other-options-link');
            if (otherOptionsLink) {
                otherOptionsLink.textContent = `Ver 3 opciones desde ${product.moneda} ${price}`;
            }

            // Render payment methods
            const paymentMethodsContent = document.getElementById('payment-methods-content');
            paymentMethodsContent.innerHTML = '';

            const paymentCategories = {
                "Tarjetas de crédito": ["Visa", "Mastercard", "American Express", "OCA Blue"],
                "Tarjetas de débito": ["Visa Débito", "Mastercard Débito"],
                "Efectivo": ["Abitab", "RedPagos"]
            };

            const paymentLogos = {
                "Visa": "https://http2.mlstatic.com/storage/logos-api-admin/a5f047d0-9be0-11ec-aad4-c3381f368aaf-m.svg",
                "Mastercard": "https://http2.mlstatic.com/storage/logos-api-admin/aa2b8f70-5c85-11ec-ae75-df2bef173be2-m.svg",
                "American Express": "https://http2.mlstatic.com/storage/logos-api-admin/b2c93a40-f3be-11eb-9984-b7076edb0bb7-m.svg",
                "OCA Blue": "https://ocablue.uy/src/img/logo-oca-blue.svg",
                "Visa Débito": "https://http2.mlstatic.com/storage/logos-api-admin/312238e0-571b-11e8-823a-758d95db88db-m.svg",
                "Mastercard Débito": "https://http2.mlstatic.com/storage/logos-api-admin/157dce60-571b-11e8-95d8-631c1a9a92a9-m.svg",
                "Abitab": "https://www.abitab.com.uy/abitab/theme/img/abitab_logo.png",
                "RedPagos": "https://http2.mlstatic.com/storage/logos-api-admin/e5ee1d00-f39b-11eb-8e0d-6f4af49bf82e-m.svg"
            };

            for (const category in paymentCategories) {
                const availableMethods = paymentCategories[category].filter(method => product.metodos_pago.includes(method));
                
                if (availableMethods.length > 0) {
                    let categoryHtml = `
                        <div class="mb-4">
                            <p class="font-semibold text-gray-800 mb-2">${category}</p>
                    `;
                    if (category === "Tarjetas de crédito") {
                        categoryHtml += `<p class="text-sm text-gray-600 mb-2">¡Cuotas sin interés con bancos seleccionados!</p>`;
                    }
                    categoryHtml += `<div class="flex gap-3 items-center">`;
                    
                    availableMethods.forEach(method => {
                        const logoSrc = paymentLogos[method];
                        if (logoSrc) {
                            categoryHtml += `<img src="${logoSrc}" alt="${method}" class="h-6">`;
                        }
                    });
                    categoryHtml += `</div></div>`;
                    paymentMethodsContent.innerHTML += categoryHtml;
                }
            }
        }

        function renderRelatedProducts(allProducts, currentProductId) {
            const relatedGrid = document.getElementById('related-products-grid');
            relatedGrid.innerHTML = '';

            // Convert the allProducts object to an array and shuffle it
            const productsArray = Object.values(allProducts);
            const shuffledProducts = productsArray.sort(() => 0.5 - Math.random());

            let count = 0;
            for (const product of shuffledProducts) {
                if (product.id === currentProductId) continue; // Do not show the current product
                if (count >= 5) break; // Limit to 5 related products

                const cardLink = document.createElement('a');
                cardLink.href = `?id=${product.id}`;
                cardLink.className = 'bg-white rounded-lg shadow-sm p-4 flex flex-col hover:shadow-xl transition-shadow duration-300 border';
                cardLink.onclick = (event) => { // Add onclick to handle navigation and data loading
                    event.preventDefault(); // Prevent default link behavior
                    history.pushState(null, '', cardLink.href); // Update URL without full reload
                    loadProductData(); // Load new product data
                };

                cardLink.innerHTML = `
                    <img src="${product.imagenes[0]}" alt="${product.titulo}" class="w-full h-40 object-contain mb-4 border-b pb-4">
                    <p class="text-sm text-gray-600 flex-grow">${product.titulo}</p>
                    <p class="text-xl font-light text-gray-900 mt-2">${product.moneda} ${new Intl.NumberFormat('es-UY').format(product.precio)}</p>
                `;
                relatedGrid.appendChild(cardLink);
                count++;
            }
            document.getElementById('related-products-section').classList.remove('hidden');
        }

        function renderSellerProducts(allProducts, currentProductId, currentSellerId, sellerName) {
            const sellerProductsSection = document.getElementById('seller-products-section');
            const sellerProductsTitle = document.getElementById('seller-products-title');
            const sellerProductsGrid = document.getElementById('seller-products-grid');
            sellerProductsGrid.innerHTML = '';

            const productsBySeller = Object.values(allProducts).filter(product => 
                product.vendedor_id === currentSellerId && product.id !== currentProductId
            );

            if (productsBySeller.length > 0) {
                sellerProductsTitle.textContent = `Más productos de ${sellerName}`;
                productsBySeller.slice(0, 5).forEach(product => { // Limit to 5 seller products
                    const cardLink = document.createElement('a');
                    cardLink.href = `?id=${product.id}`;
                    cardLink.className = 'bg-white rounded-lg shadow-sm p-4 flex flex-col hover:shadow-xl transition-shadow duration-300 border';
                    cardLink.onclick = (event) => { // Add onclick to handle navigation and data loading
                        event.preventDefault(); // Prevent default link behavior
                        history.pushState(null, '', cardLink.href); // Update URL without full reload
                        loadProductData(); // Load new product data
                    };

                    cardLink.innerHTML = `
                        <img src="${product.imagenes[0]}" alt="${product.titulo}" class="w-full h-40 object-contain mb-4 border-b pb-4">
                        <p class="text-sm text-gray-600 flex-grow">${product.titulo}</p>
                        <p class="text-xl font-light text-gray-900 mt-2">${product.moneda} ${new Intl.NumberFormat('es-UY').format(product.precio)}</p>
                    `;
                    sellerProductsGrid.appendChild(cardLink);
                });
                sellerProductsSection.classList.remove('hidden');
            } else {
                sellerProductsSection.classList.add('hidden');
            }
        }
    </script>

</body>
</html>
